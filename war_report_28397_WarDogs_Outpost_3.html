<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>War Report: Banty Shack vs WarDogs Outpost (War ID: 28397)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #d1d5db; }
        .card { background-color: #1f2937; border: 1px solid #374151; border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 1.5rem; }
        .table-header { background-color: #374151; }
        .table-row-light { background-color: #2b3544; transition: background-color 0.2s; }
        .table-row-light:hover { background-color: #374151; }
        .details-row { background-color: #1a222e; }
        .details-row td { padding: 1rem 1.5rem; }
        .details-item { display: flex; justify-content: space-between; padding: 0.25rem 0; }
        input[type="text"], input[type="number"] { background-color: #374151; border: 1px solid #4b5563; border-radius: 0.375rem; color: white; padding: 0.5rem; width: 100%;}
        input:disabled { background-color: #2b3544; color: #9ca3af; cursor: not-allowed; }
        .highlight-row { background-color: #4a3a22; }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="max-w-7xl mx-auto">
        <div id="report-container">
            <header class="text-center mb-8">
                <h1 class="text-4xl font-bold text-white">Ranked War Report</h1>
                <h2 class="text-2xl text-cyan-400">Banty Shack vs WarDogs Outpost</h2>
                <p class="text-gray-400 mt-1">War ID: 28397 | Profile: Standard</p>
            </header>

            <div class="card">
                <h3 class="text-xl font-semibold text-white mb-2">Payout Rules</h3>
                <p class="text-gray-400 italic">"Payout is based on respect share. 10% of the prize pool is reserved as a bonus for chain contributors."</p>
            </div>

            <div class="card mt-4">
                <h3 class="text-xl font-semibold text-white mb-4">Payout Parameters</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-center">
                    <div>
                        <label for="prizeTotalInput" class="block text-sm font-medium text-gray-400">Total Prize Pool ($)</label>
                        <input type="text" id="prizeTotalInput" class="mt-1" value="1000000000">
                    </div>
                    <div>
                        <label for="factionPoolPct" class="block text-sm font-medium text-gray-400">Faction Pool %</label>
                        <input type="number" id="factionPoolPct" class="mt-1" value="10">
                    </div>
                    <div>
                        <label for="chainHitsPoolPct" class="block text-sm font-medium text-gray-400">Chain Bonus Pool %</label>
                        <input type="number" id="chainHitsPoolPct" class="mt-1" value="10">
                    </div>
                    <div>
                        <label for="assistsPoolPct" class="block text-sm font-medium text-gray-400">Assist Bonus Pool %</label>
                        <input type="number" id="assistsPoolPct" class="mt-1" value="0">
                    </div>
                </div>
            </div>

            <div class="card">
                <h3 class="text-xl font-semibold text-white mb-4">Member Payouts (Click a row for details)</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="table-header">
                            <tr>
                                <th class="p-3">Status</th>
                                <th class="p-3">Member (Click to copy)</th>
                                <th class="p-3 text-right">Respect</th>
                                <th class="p-3 text-right">Chain Hits</th>
                                <th class="p-3 text-right">Assists</th>
                                <th class="p-3 text-right font-bold">Total Prize (Click to pay)</th>
                            </tr>
                        </thead>
                        <tbody id="member-table-body">
                            </tbody>
                    </table>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                <div class="card">
                    <h3 class="text-xl font-semibold text-white mb-4 text-center">Prize Pool Distribution</h3>
                    <canvas id="prizePoolChart"></canvas>
                </div>
                <div class="card">
                    <h3 class="text-xl font-semibold text-white mb-4 text-center">Top 10 Earners</h3>
                    <canvas id="topEarnersChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="mt-8 flex justify-center space-x-4">
             <button onclick="takeScreenshot()" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-md text-white transition-colors" title="Download Screenshot"><i class="fas fa-camera"></i></button>
             <button onclick="toggleLock()" id="lockButton" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-md text-white transition-colors" title="Lock/Unlock Inputs"><i class="fas fa-lock"></i></button>
        </div>
    </div>

    <script>
        // --- Data Passed from Python ---
        let membersData = [{"assists": 0, "chain_hits": 117, "id": 3055867, "name": "Ozymandilgamesh (Ex-Member)", "payouts": {"Chain Bonus": 8560975.609756097, "Main Pool (Respect)": 102835430.93147245}, "respect": 1059.2899999999997, "total_payout": 111396406.54122855}, {"assists": 0, "chain_hits": 129, "id": 3443221, "name": "Alexalbrecht (Ex-Member)", "payouts": {"Chain Bonus": 9439024.390243903, "Main Pool (Respect)": 76255041.24683733}, "respect": 785.49, "total_payout": 85694065.63708124}, {"assists": 2, "chain_hits": 106, "id": 3434976, "name": "MrNic3Guy (Ex-Member)", "payouts": {"Assist Bonus": 0.0, "Chain Bonus": 7756097.56097561, "Main Pool (Respect)": 71609783.22488776}, "respect": 737.6399999999999, "total_payout": 79365880.78586337}, {"assists": 1, "chain_hits": 98, "id": 3453925, "name": "Sniperpirate (Ex-Member)", "payouts": {"Assist Bonus": 0.0, "Chain Bonus": 7170731.707317074, "Main Pool (Respect)": 70819555.42345266}, "respect": 729.4999999999999, "total_payout": 77990287.13076973}, {"assists": 0, "chain_hits": 71, "id": 1936261, "name": "Galabrielle (Ex-Member)", "payouts": {"Chain Bonus": 5195121.951219512, "Main Pool (Respect)": 59915576.71863813}, "respect": 617.18, "total_payout": 65110698.66985764}, {"assists": 1, "chain_hits": 81, "id": 3579042, "name": "Cambris (Ex-Member)", "payouts": {"Assist Bonus": 0.0, "Chain Bonus": 5926829.268292683, "Main Pool (Respect)": 57058524.606078595}, "respect": 587.7500000000003, "total_payout": 62985353.874371275}, {"assists": 0, "chain_hits": 64, "id": 2316623, "name": "kok (Ex-Member)", "payouts": {"Chain Bonus": 4682926.8292682925, "Main Pool (Respect)": 57367237.67838367}, "respect": 590.9300000000001, "total_payout": 62050164.50765196}, {"assists": 0, "chain_hits": 85, "id": 3411750, "name": "xeQt (Ex-Member)", "payouts": {"Chain Bonus": 6219512.195121951, "Main Pool (Respect)": 53641323.30257541}, "respect": 552.5499999999998, "total_payout": 59860835.49769736}, {"assists": 3, "chain_hits": 64, "id": 3200108, "name": "AJGarnett (Ex-Member)", "payouts": {"Assist Bonus": 0.0, "Chain Bonus": 4682926.8292682925, "Main Pool (Respect)": 39623031.59161372}, "respect": 408.15, "total_payout": 44305958.42088201}, {"assists": 1, "chain_hits": 82, "id": 3445819, "name": "Rollafattie (Ex-Member)", "payouts": {"Assist Bonus": 0.0, "Chain Bonus": 6000000.0, "Main Pool (Respect)": 36659191.93831967}, "respect": 377.62, "total_payout": 42659191.93831967}, {"assists": 0, "chain_hits": 65, "id": 2334296, "name": "SideBoobBob (Ex-Member)", "payouts": {"Chain Bonus": 4756097.56097561, "Main Pool (Respect)": 36579586.68068123}, "respect": 376.7999999999999, "total_payout": 41335684.24165684}, {"assists": 1, "chain_hits": 55, "id": 3440219, "name": "EnzoGallo (Ex-Member)", "payouts": {"Assist Bonus": 0.0, "Chain Bonus": 4024390.2439024393, "Main Pool (Respect)": 35088444.29369808}, "respect": 361.4400000000002, "total_payout": 39112834.53760052}, {"assists": 0, "chain_hits": 69, "id": 3128809, "name": "dojacow (Ex-Member)", "payouts": {"Chain Bonus": 5048780.4878048785, "Main Pool (Respect)": 32239158.54773738}, "respect": 332.09000000000026, "total_payout": 37287939.03554226}, {"assists": 0, "chain_hits": 43, "id": 3355638, "name": "CannibalKing (Ex-Member)", "payouts": {"Chain Bonus": 3146341.463414634, "Main Pool (Respect)": 30541236.65005923}, "respect": 314.59999999999997, "total_payout": 33687578.11347386}, {"assists": 0, "chain_hits": 32, "id": 3360442, "name": "Dunne (Ex-Member)", "payouts": {"Chain Bonus": 2341463.4146341463, "Main Pool (Respect)": 21248779.014510382}, "respect": 218.88000000000005, "total_payout": 23590242.429144528}, {"assists": 0, "chain_hits": 33, "id": 3134388, "name": "Br1ck (Ex-Member)", "payouts": {"Chain Bonus": 2414634.1463414636, "Main Pool (Respect)": 13633856.564317606}, "respect": 140.44000000000003, "total_payout": 16048490.71065907}, {"assists": 0, "chain_hits": 34, "id": 1902786, "name": "Dakingace (Ex-Member)", "payouts": {"Chain Bonus": 2487804.8780487804, "Main Pool (Respect)": 13014488.828057664}, "respect": 134.06, "total_payout": 15502293.706106443}, {"assists": 0, "chain_hits": 2, "id": 1458884, "name": "YungBevXO (Ex-Member)", "payouts": {"Chain Bonus": 146341.46341463414, "Main Pool (Respect)": 1869752.7586781336}, "respect": 19.26, "total_payout": 2016094.2220927677}, {"assists": 0, "chain_hits": 0, "id": 3141995, "name": "WD-001 (Ex-Member)", "payouts": {}, "respect": 0}, {"assists": 0, "chain_hits": 0, "id": 3670356, "name": "Firecracker_Jim (Ex-Member)", "payouts": {}, "respect": 0}, {"assists": 0, "chain_hits": 0, "id": 2641551, "name": "GRex (Ex-Member)", "payouts": {}, "respect": 0}, {"assists": 0, "chain_hits": 0, "id": 2608834, "name": "BrownEyedGirl7 (Ex-Member)", "payouts": {}, "respect": 0}, {"assists": 0, "chain_hits": 0, "id": 2606458, "name": "Maionese (Ex-Member)", "payouts": {}, "respect": 0}, {"assists": 0, "chain_hits": 0, "id": 3633350, "name": "strainge (Ex-Member)", "payouts": {}, "respect": 0}, {"assists": 0, "chain_hits": 0, "id": 3720679, "name": "snyperfxza (Ex-Member)", "payouts": {}, "respect": 0}, {"assists": 0, "chain_hits": 0, "id": 3257746, "name": "KieranH95 (Ex-Member)", "payouts": {}, "respect": 0}, {"assists": 0, "chain_hits": 0, "id": 3010113, "name": "Greentoad (Ex-Member)", "payouts": {}, "respect": 0}, {"assists": 1, "chain_hits": 0, "id": 3587415, "name": "ZeroTheeHero (Ex-Member)", "payouts": {"Assist Bonus": 0.0}, "respect": 0, "total_payout": 0.0}, {"assists": 0, "chain_hits": 0, "id": 3210452, "name": "kurapylly (Ex-Member)", "payouts": {}, "respect": 0}, {"assists": 0, "chain_hits": 0, "id": 3615043, "name": "Clutchie (Ex-Member)", "payouts": {}, "respect": 0}];
        const summaryStats = JSON.parse('{"total_respect": 8343.67000000001, "total_chain_hits": 1230, "total_assists": 10}');
        const profileModel = 'multi_pool';
        const warId = '28397';
        
        // --- Global Variables ---
        let prizePoolChart, topEarnersChart, lastHighlightedRow = null;
        const inputIds = ['prizeTotalInput', 'factionPoolPct', 'chainHitsPoolPct', 'assistsPoolPct'];
        const inputs = inputIds.map(id => document.getElementById(id));
        const lockButton = document.getElementById('lockButton');

        // --- Formatting Helpers ---
        const formatCurrency = (value) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value);
        const formatInputNumber = (n) => n.toString().replace(/\D/g, "").replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        const parseInputNumber = (s) => parseFloat(s.replace(/,/g, '')) || 0;

        // --- Core Calculation & Rendering Logic ---
        function calculateAndRender() {
            // 1. Get current values from inputs
            const prizeTotal = parseInputNumber(document.getElementById('prizeTotalInput').value);
            const factionPct = parseFloat(document.getElementById('factionPoolPct').value) || 0;
            let chainPct = parseFloat(document.getElementById('chainHitsPoolPct').value) || 0;
            let assistPct = parseFloat(document.getElementById('assistsPoolPct').value) || 0;

            // In equal share model, bonus pools are ignored.
            if (profileModel === 'equal_share') {
                chainPct = 0;
                assistPct = 0;
            }

            // 2. Filter for enabled members and calculate their total contributions
            const enabledMembers = membersData.filter(m => m.enabled);
            const totalEnabled = {
                respect: enabledMembers.reduce((sum, m) => sum + m.respect, 0),
                chain_hits: enabledMembers.reduce((sum, m) => sum + m.chain_hits, 0),
                assists: enabledMembers.reduce((sum, m) => sum + m.assists, 0),
            };

            // 3. Calculate pool sizes
            const factionPool = prizeTotal * (factionPct / 100);
            const memberPool = prizeTotal - factionPool;
            let mainPayoutPool = 0, chainPool = 0, assistPool = 0;

            // 4. Calculate payouts for each member
            if (profileModel === 'equal_share') {
                mainPayoutPool = memberPool;
                const share = enabledMembers.length > 0 ? mainPayoutPool / enabledMembers.length : 0;
                membersData.forEach(member => {
                    member.payouts = {};
                    if (member.enabled) {
                        member.payouts['Equal Share'] = share;
                    }
                    member.total_payout = Object.values(member.payouts).reduce((a, b) => a + b, 0);
                });
            } else { // multi_pool
                chainPool = memberPool * (chainPct / 100);
                assistPool = memberPool * (assistPct / 100);
                mainPayoutPool = memberPool - chainPool - assistPool;

                membersData.forEach(member => {
                    member.payouts = {};
                    if (member.enabled) {
                         if (totalEnabled.respect > 0 && member.respect > 0) {
                            member.payouts['Main Pool (Respect)'] = mainPayoutPool * (member.respect / totalEnabled.respect);
                        }
                        if (totalEnabled.chain_hits > 0 && member.chain_hits > 0) {
                            member.payouts['Chain Bonus'] = chainPool * (member.chain_hits / totalEnabled.chain_hits);
                        }
                        if (totalEnabled.assists > 0 && member.assists > 0) {
                            member.payouts['Assist Bonus'] = assistPool * (member.assists / totalEnabled.assists);
                        }
                    }
                    member.total_payout = Object.values(member.payouts).reduce((a, b) => a + b, 0);
                });
            }

            // 5. Sort members by new total payout
            membersData.sort((a, b) => b.total_payout - a.total_payout);

            // 6. Re-render the table
            const tableBody = document.getElementById('member-table-body');
            tableBody.innerHTML = ''; // Clear existing rows
            membersData.forEach(member => {
                const row = document.createElement('tr');
                row.className = 'table-row-light';
                
                let breakdownHtml = '';
                for (const [pool_name, amount] of Object.entries(member.payouts || {})) {
                    if (amount > 0) {
                        breakdownHtml += `<div class="details-item text-gray-300"><span>${pool_name}:</span><span class="font-mono">${formatCurrency(amount)}</span></div>`;
                    }
                }
                
                const statusButtonClass = member.enabled ? 'bg-green-500 hover:bg-green-600' : 'bg-red-500 hover:bg-red-600';
                const statusButtonIcon = member.enabled ? '<i class="fas fa-check"></i>' : '<i class="fas fa-times"></i>';

                row.innerHTML = `
                    <td class="p-3"><button class="status-toggle p-2 w-8 h-8 rounded-full text-white ${statusButtonClass}">${statusButtonIcon}</button></td>
                    <td class="p-3 cursor-pointer" onclick="copyMemberInfo(this)">
                        <a href="https://www.torn.com/profiles.php?XID=${member.id}" target="_blank" class="text-cyan-400 hover:underline">${member.name} [${member.id}]</a>
                    </td>
                    <td class="p-3 text-right">${member.respect.toFixed(2)}</td>
                    <td class="p-3 text-right">${member.chain_hits}</td>
                    <td class="p-3 text-right">${member.assists}</td>
                    <td class="p-3 text-right font-bold text-green-400">
                         <a href="https://www.torn.com/factions.php?step=your#/tab=controls&option=give-to-user&addMoneyTo=${member.id}&money=${Math.round(member.total_payout)}" target="_blank" class="text-green-400 hover:underline" onclick="highlightRow(this.closest('tr')); event.stopPropagation();">
                            ${formatCurrency(member.total_payout)}
                        </a>
                    </td>
                `;
                row.onclick = () => toggleDetails(row);
                row.querySelector('.status-toggle').onclick = (e) => { e.stopPropagation(); togglePlayerStatus(member.id); };
                tableBody.appendChild(row);

                const detailsRow = document.createElement('tr');
                detailsRow.className = 'details-row';
                detailsRow.style.display = 'none';
                detailsRow.innerHTML = `<td colspan="6"><div class="details-content"><h4 class="font-semibold text-white mb-2">Payout Breakdown:</h4>${breakdownHtml || 'No payout from any pool.'}</div></td>`;
                tableBody.appendChild(detailsRow);
            });

            // 7. Update charts and save
            updateCharts({ factionPool, mainPayoutPool, chainPool, assistPool });
            saveToStorage();
        }

        function updateCharts(poolData) {
            const poolLabels = Object.keys(poolData).filter(k => poolData[k] > 0);
            prizePoolChart.data.labels = poolLabels;
            prizePoolChart.data.datasets[0].data = poolLabels.map(k => poolData[k]);
            prizePoolChart.update();

            const top10Members = membersData.filter(m => m.enabled).slice(0, 10);
            topEarnersChart.data.labels = top10Members.map(m => `${m.name.split(' ')[0]}`);
            topEarnersChart.data.datasets[0].data = top10Members.map(m => m.total_payout);
            topEarnersChart.update();
        }

        // --- Interactivity & Storage ---
        function toggleDetails(rowElement) {
            const detailsRow = rowElement.nextElementSibling;
            if (detailsRow && detailsRow.classList.contains('details-row')) {
                detailsRow.style.display = detailsRow.style.display === 'none' ? 'table-row' : 'none';
            }
        }
        
        function togglePlayerStatus(memberId) {
            const member = membersData.find(m => m.id === memberId);
            if(member) member.enabled = !member.enabled;
            calculateAndRender();
        }

        function highlightRow(row) {
            if (lastHighlightedRow) lastHighlightedRow.classList.remove('highlight-row');
            row.classList.add('highlight-row');
            lastHighlightedRow = row;
        }

        function copyMemberInfo(element) {
            const row = element.closest('tr');
            const memberLink = row.querySelector('a');
            const memberText = memberLink.textContent.trim();
            navigator.clipboard.writeText(memberText);
            highlightRow(row);
        }

        function takeScreenshot() {
            const el = document.getElementById('report-container');
            html2canvas(el, { backgroundColor: '#111827', scale: 1.5 }).then(canvas => {
                const link = document.createElement('a');
                link.download = `war_report_${warId}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }
        
        const storageKey = `warReportSettings-${warId}`;
        function saveToStorage() {
            const isLocked = lockButton.querySelector('i').classList.contains('fa-lock');
            if (isLocked) {
                 const settings = { isLocked };
                 inputIds.forEach(id => settings[id] = document.getElementById(id).value);
                 localStorage.setItem(storageKey, JSON.stringify(settings));
            } else {
                 localStorage.removeItem(storageKey);
            }
        }

        function loadFromStorage() {
            const settings = JSON.parse(localStorage.getItem(storageKey));
            if (settings && settings.isLocked) {
                inputIds.forEach(id => {
                    const inputEl = document.getElementById(id);
                    if (settings[id] !== undefined) inputEl.value = settings[id];
                });
            }
        }

        function toggleLock() {
            const icon = lockButton.querySelector('i');
            const willBeLocked = !icon.classList.contains('fa-lock');
            inputs.forEach(input => input.disabled = willBeLocked);
            icon.className = willBeLocked ? 'fas fa-lock' : 'fas fa-lock-open';
            saveToStorage();
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            membersData.forEach(m => m.enabled = true); // Set all members to enabled by default
            
            const poolCtx = document.getElementById('prizePoolChart').getContext('2d');
            prizePoolChart = new Chart(poolCtx, { type: 'doughnut', options: { responsive: true, plugins: { legend: { position: 'top', labels: { color: '#d1d5db' } } } }, data: { labels:[], datasets:[{ backgroundColor: ['#1f2937','#10B981', '#3B82F6', '#F59E0B'], borderColor: '#111827', borderWidth: 4 }]} });
            
            const topEarnersCtx = document.getElementById('topEarnersChart').getContext('2d');
            topEarnersChart = new Chart(topEarnersCtx, { type: 'bar', options: { indexAxis: 'y', responsive: true, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: '#9ca3af', callback: (value) => new Intl.NumberFormat('en-US', { notation: 'compact', compactDisplay: 'short' }).format(value) }, grid: { color: '#374151' } }, y: { ticks: { color: '#d1d5db' }, grid: { display: false } } } }, data: { labels: [], datasets: [{ label: 'Total Payout', backgroundColor: 'rgba(59, 130, 246, 0.7)', borderColor: 'rgba(59, 130, 246, 1)', borderWidth: 1 }]} });
            
            document.getElementById('prizeTotalInput').addEventListener('input', (e) => { e.target.value = formatInputNumber(e.target.value); calculateAndRender(); });
            inputs.slice(1).forEach(input => input.addEventListener('input', calculateAndRender));
            
            loadFromStorage();
            calculateAndRender();
            
            const settings = JSON.parse(localStorage.getItem(storageKey));
            const startLocked = !!(settings && settings.isLocked);
            inputs.forEach(input => input.disabled = startLocked);
            lockButton.querySelector('i').className = startLocked ? 'fas fa-lock' : 'fas fa-lock-open';
        });
    </script>
</body>
</html>