<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>War Report: Banty Shack vs WarDogs Outpost (War ID: 28397)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #d1d5db; }
        .card { background-color: #1f2937; border: 1px solid #374151; border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 1.5rem; }
        .table-header { background-color: #374151; }
        .table-row-light { background-color: #2b3544; cursor: pointer; transition: background-color 0.2s; }
        .table-row-light:hover { background-color: #374151; }
        .details-row { background-color: #1a222e; }
        .details-row td { padding: 1rem 1.5rem; }
        .details-item { display: flex; justify-content: space-between; padding: 0.25rem 0; }
        .input-group { position: relative; }
        input[type="text"] { background-color: #374151; border: 1px solid #4b5563; border-radius: 0.375rem; color: white; padding: 0.5rem; width: 100%;}
        input:disabled { background-color: #2b3544; color: #9ca3af; cursor: not-allowed; }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="max-w-7xl mx-auto" id="report-container">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white">Ranked War Report</h1>
            <h2 class="text-2xl text-cyan-400">Banty Shack vs WarDogs Outpost</h2>
            <p class="text-gray-400 mt-1">War ID: 28397 | Profile: AdvancedIncentives</p>
        </header>

        <div class="card flex justify-between items-center">
             <div class="flex-grow">
                <h3 class="text-xl font-semibold text-white mb-2">Payout Rules</h3>
                <p class="text-gray-400 italic">"Payout is based on respect, but with separate cash pools rewarding chain hits and assists."</p>
            </div>
             <div class="flex items-center space-x-2">
                 <button onclick="toggleLock()" id="lockButton" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-md text-white transition-colors"><i class="fas fa-lock-open"></i></button>
                 <button onclick="takeScreenshot()" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-md text-white transition-colors"><i class="fas fa-camera"></i> Screenshot</button>
            </div>
        </div>

        <div class="card mt-4">
            <h3 class="text-xl font-semibold text-white mb-4">Payout Parameters</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-center">
                <div>
                    <label for="prizeTotalInput" class="block text-sm font-medium text-gray-400">Total Prize Pool ($)</label>
                    <input type="text" id="prizeTotalInput" class="mt-1" value="1000000000">
                </div>
                <div>
                    <label for="factionPoolPct" class="block text-sm font-medium text-gray-400">Faction Pool %</label>
                    <input type="text" id="factionPoolPct" class="mt-1" value="15">
                </div>
                <div>
                    <label for="chainHitsPoolPct" class="block text-sm font-medium text-gray-400">Chain Bonus Pool %</label>
                    <input type="text" id="chainHitsPoolPct" class="mt-1" value="15">
                </div>
                <div>
                    <label for="assistsPoolPct" class="block text-sm font-medium text-gray-400">Assist Bonus Pool %</label>
                    <input type="text" id="assistsPoolPct" class="mt-1" value="5">
                </div>
            </div>
        </div>

        <div class="card">
            <h3 class="text-xl font-semibold text-white mb-4">Member Payouts (Click a row for details)</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="table-header">
                        <tr>
                            <th class="p-3">Member</th>
                            <th class="p-3 text-right">Respect</th>
                            <th class="p-3 text-right">Chain Hits</th>
                            <th class="p-3 text-right">Assists</th>
                            <th class="p-3 text-right font-bold">Total Prize</th>
                        </tr>
                    </thead>
                    <tbody id="member-table-body">
                        </tbody>
                </table>
            </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
            <div class="card">
                <h3 class="text-xl font-semibold text-white mb-4 text-center">Prize Pool Distribution</h3>
                <canvas id="prizePoolChart"></canvas>
            </div>
            <div class="card">
                <h3 class="text-xl font-semibold text-white mb-4 text-center">Top 10 Earners</h3>
                <canvas id="topEarnersChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // --- Data Passed from Python ---
        let membersData = [{"assists": 0, "chain_hits": 117, "id": 3055867, "name": "Ozymandilgamesh (Ex-Member)", "payouts": {"Chain Bonus": 12128048.780487806, "Main Pool (Respect)": 86330979.05358182}, "respect": 1059.2899999999997, "total_payout": 98459027.83406962}, {"assists": 2, "chain_hits": 106, "id": 3434976, "name": "MrNic3Guy (Ex-Member)", "payouts": {"Assist Bonus": 8500000.0, "Chain Bonus": 10987804.878048781, "Main Pool (Respect)": 60116855.052992195}, "respect": 737.6399999999999, "total_payout": 79604659.93104097}, {"assists": 0, "chain_hits": 129, "id": 3443221, "name": "Alexalbrecht (Ex-Member)", "payouts": {"Chain Bonus": 13371951.219512194, "Main Pool (Respect)": 64016577.8368511}, "respect": 785.49, "total_payout": 77388529.05636328}, {"assists": 1, "chain_hits": 98, "id": 3453925, "name": "Sniperpirate (Ex-Member)", "payouts": {"Assist Bonus": 4250000.0, "Chain Bonus": 10158536.585365854, "Main Pool (Respect)": 59453453.935738035}, "respect": 729.4999999999999, "total_payout": 73861990.52110389}, {"assists": 1, "chain_hits": 81, "id": 3579042, "name": "Cambris (Ex-Member)", "payouts": {"Assist Bonus": 4250000.0, "Chain Bonus": 8396341.463414634, "Main Pool (Respect)": 47900983.61991783}, "respect": 587.7500000000003, "total_payout": 60547325.083332464}, {"assists": 0, "chain_hits": 71, "id": 1936261, "name": "Galabrielle (Ex-Member)", "payouts": {"Chain Bonus": 7359756.097560976, "Main Pool (Respect)": 50299496.50453571}, "respect": 617.18, "total_payout": 57659252.60209669}, {"assists": 0, "chain_hits": 64, "id": 2316623, "name": "kok (Ex-Member)", "payouts": {"Chain Bonus": 6634146.341463415, "Main Pool (Respect)": 48160150.1497542}, "respect": 590.9300000000001, "total_payout": 54794296.49121761}, {"assists": 0, "chain_hits": 85, "id": 3411750, "name": "xeQt (Ex-Member)", "payouts": {"Chain Bonus": 8810975.609756097, "Main Pool (Respect)": 45032222.0317917}, "respect": 552.5499999999998, "total_payout": 53843197.6415478}, {"assists": 3, "chain_hits": 64, "id": 3200108, "name": "AJGarnett (Ex-Member)", "payouts": {"Assist Bonus": 12750000.0, "Chain Bonus": 6634146.341463415, "Main Pool (Respect)": 33263779.607774477}, "respect": 408.15, "total_payout": 52647925.94923789}, {"assists": 1, "chain_hits": 82, "id": 3445819, "name": "Rollafattie (Ex-Member)", "payouts": {"Assist Bonus": 4250000.0, "Chain Bonus": 8500000.0, "Main Pool (Respect)": 30775617.92352762}, "respect": 377.62, "total_payout": 43525617.92352762}, {"assists": 1, "chain_hits": 55, "id": 3440219, "name": "EnzoGallo (Ex-Member)", "payouts": {"Assist Bonus": 4250000.0, "Chain Bonus": 5701219.512195122, "Main Pool (Respect)": 29456965.579894684}, "respect": 361.4400000000002, "total_payout": 39408185.09208981}, {"assists": 0, "chain_hits": 65, "id": 2334296, "name": "SideBoobBob (Ex-Member)", "payouts": {"Chain Bonus": 6737804.878048781, "Main Pool (Respect)": 30708788.818349674}, "respect": 376.7999999999999, "total_payout": 37446593.69639845}, {"assists": 0, "chain_hits": 69, "id": 3128809, "name": "dojacow (Ex-Member)", "payouts": {"Chain Bonus": 7152439.024390244, "Main Pool (Respect)": 27064972.60797706}, "respect": 332.09000000000026, "total_payout": 34217411.632367305}, {"assists": 0, "chain_hits": 43, "id": 3355638, "name": "CannibalKing (Ex-Member)", "payouts": {"Chain Bonus": 4457317.073170732, "Main Pool (Respect)": 25639556.693876885}, "respect": 314.59999999999997, "total_payout": 30096873.767047618}, {"assists": 0, "chain_hits": 32, "id": 3360442, "name": "Dunne (Ex-Member)", "payouts": {"Chain Bonus": 3317073.1707317075, "Main Pool (Respect)": 17838481.147984024}, "respect": 218.88000000000005, "total_payout": 21155554.318715733}, {"assists": 0, "chain_hits": 33, "id": 3134388, "name": "Br1ck (Ex-Member)", "payouts": {"Chain Bonus": 3420731.707317073, "Main Pool (Respect)": 11445706.745353052}, "respect": 140.44000000000003, "total_payout": 14866438.452670125}, {"assists": 0, "chain_hits": 34, "id": 1902786, "name": "Dakingace (Ex-Member)", "payouts": {"Chain Bonus": 3524390.243902439, "Main Pool (Respect)": 10925743.7075052}, "respect": 134.06, "total_payout": 14450133.95140764}, {"assists": 1, "chain_hits": 0, "id": 3587415, "name": "ZeroTheeHero (Ex-Member)", "payouts": {"Assist Bonus": 4250000.0}, "respect": 0, "total_payout": 4250000.0}, {"assists": 0, "chain_hits": 2, "id": 1458884, "name": "YungBevXO (Ex-Member)", "payouts": {"Chain Bonus": 207317.07317073172, "Main Pool (Respect)": 1569668.9825939888}, "respect": 19.26, "total_payout": 1776986.0557647205}, {"assists": 0, "chain_hits": 0, "id": 3141995, "name": "WD-001 (Ex-Member)", "payouts": {}, "respect": 0}, {"assists": 0, "chain_hits": 0, "id": 3670356, "name": "Firecracker_Jim (Ex-Member)", "payouts": {}, "respect": 0}, {"assists": 0, "chain_hits": 0, "id": 2641551, "name": "GRex (Ex-Member)", "payouts": {}, "respect": 0}, {"assists": 0, "chain_hits": 0, "id": 2608834, "name": "BrownEyedGirl7 (Ex-Member)", "payouts": {}, "respect": 0}, {"assists": 0, "chain_hits": 0, "id": 2606458, "name": "Maionese (Ex-Member)", "payouts": {}, "respect": 0}, {"assists": 0, "chain_hits": 0, "id": 3633350, "name": "strainge (Ex-Member)", "payouts": {}, "respect": 0}, {"assists": 0, "chain_hits": 0, "id": 3720679, "name": "snyperfxza (Ex-Member)", "payouts": {}, "respect": 0}, {"assists": 0, "chain_hits": 0, "id": 3257746, "name": "KieranH95 (Ex-Member)", "payouts": {}, "respect": 0}, {"assists": 0, "chain_hits": 0, "id": 3010113, "name": "Greentoad (Ex-Member)", "payouts": {}, "respect": 0}, {"assists": 0, "chain_hits": 0, "id": 3210452, "name": "kurapylly (Ex-Member)", "payouts": {}, "respect": 0}, {"assists": 0, "chain_hits": 0, "id": 3615043, "name": "Clutchie (Ex-Member)", "payouts": {}, "respect": 0}];
        const summaryStats = JSON.parse('{"total_respect": 8343.67000000001, "total_chain_hits": 1230, "total_assists": 10}');
        const profileModel = 'multi_pool';
        const warId = '28397';
        
        // --- Global Variables ---
        let prizePoolChart, topEarnersChart;
        const inputIds = ['prizeTotalInput', 'factionPoolPct', 'chainHitsPoolPct', 'assistsPoolPct'];
        const inputs = inputIds.map(id => document.getElementById(id));

        // --- Formatting Helper ---
        const formatCurrency = (value) => {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value);
        };
        const formatNumber = (value) => {
            return new Intl.NumberFormat('en-US').format(value);
        }

        // --- Core Calculation & Rendering Logic ---
        function calculateAndRender() {
            // 1. Get current values from inputs
            const prizeTotal = parseFloat(document.getElementById('prizeTotalInput').value.replace(/[^0-9.]/g, '')) || 0;
            const factionPct = parseFloat(document.getElementById('factionPoolPct').value) || 0;
            const chainPct = parseFloat(document.getElementById('chainHitsPoolPct').value) || 0;
            const assistPct = parseFloat(document.getElementById('assistsPoolPct').value) || 0;

            // 2. Calculate pool sizes
            const factionPool = prizeTotal * (factionPct / 100);
            const memberPool = prizeTotal - factionPool;
            let mainPayoutPool = 0, chainPool = 0, assistPool = 0;

            // 3. Calculate payouts for each member
            if (profileModel === 'equal_share') {
                mainPayoutPool = memberPool;
                const activeMembers = membersData.filter(m => m.respect > 0 || m.chain_hits > 0 || m.assists > 0);
                const share = activeMembers.length > 0 ? mainPayoutPool / activeMembers.length : 0;
                membersData.forEach(member => {
                    member.payouts = {};
                    if (activeMembers.some(am => am.id === member.id)) {
                        member.payouts['Equal Share'] = share;
                    }
                    member.total_payout = Object.values(member.payouts).reduce((a, b) => a + b, 0);
                });
            } else { // multi_pool
                chainPool = memberPool * (chainPct / 100);
                assistPool = memberPool * (assistPct / 100);
                mainPayoutPool = memberPool - chainPool - assistPool;

                membersData.forEach(member => {
                    member.payouts = {};
                    if (summaryStats.total_respect > 0 && member.respect > 0) {
                        member.payouts['Main Pool (Respect)'] = mainPayoutPool * (member.respect / summaryStats.total_respect);
                    }
                    if (summaryStats.total_chain_hits > 0 && member.chain_hits > 0) {
                        member.payouts['Chain Bonus'] = chainPool * (member.chain_hits / summaryStats.total_chain_hits);
                    }
                    if (summaryStats.total_assists > 0 && member.assists > 0) {
                        member.payouts['Assist Bonus'] = assistPool * (member.assists / summaryStats.total_assists);
                    }
                    member.total_payout = Object.values(member.payouts).reduce((a, b) => a + b, 0);
                });
            }

            // 4. Sort members by new total payout
            membersData.sort((a, b) => b.total_payout - a.total_payout);

            // 5. Re-render the table
            const tableBody = document.getElementById('member-table-body');
            tableBody.innerHTML = ''; // Clear existing rows
            membersData.forEach(member => {
                const row = document.createElement('tr');
                row.className = 'table-row-light';
                row.onclick = () => toggleDetails(row);
                
                let breakdownHtml = '';
                for (const [pool_name, amount] of Object.entries(member.payouts)) {
                    if (amount > 0) {
                        breakdownHtml += `<div class="details-item text-gray-300"><span>${pool_name}:</span><span class="font-mono">${formatCurrency(amount)}</span></div>`;
                    }
                }

                row.innerHTML = `
                    <td class="p-3">
                        <a href="https://www.torn.com/profiles.php?XID=${member.id}" target="_blank" class="text-cyan-400 hover:underline">${member.name} [${member.id}]</a>
                    </td>
                    <td class="p-3 text-right">${formatNumber(member.respect.toFixed(2))}</td>
                    <td class="p-3 text-right">${member.chain_hits}</td>
                    <td class="p-3 text-right">${member.assists}</td>
                    <td class="p-3 text-right font-bold text-green-400">${formatCurrency(member.total_payout)}</td>
                `;
                tableBody.appendChild(row);

                const detailsRow = document.createElement('tr');
                detailsRow.className = 'details-row';
                detailsRow.style.display = 'none';
                detailsRow.innerHTML = `<td colspan="5"><div class="details-content"><h4 class="font-semibold text-white mb-2">Payout Breakdown:</h4>${breakdownHtml || 'No payout from any pool.'}</div></td>`;
                tableBody.appendChild(detailsRow);
            });

            // 6. Update charts
            updateCharts({ factionPool, mainPayoutPool, chainPool, assistPool });
            saveToStorage();
        }

        function updateCharts(poolData) {
            // Update Prize Pool Chart
            const poolLabels = Object.keys(poolData).filter(k => poolData[k] > 0);
            prizePoolChart.data.labels = poolLabels;
            prizePoolChart.data.datasets[0].data = poolLabels.map(k => poolData[k]);
            prizePoolChart.update();

            // Update Top Earners Chart
            const top10Members = membersData.slice(0, 10);
            topEarnersChart.data.labels = top10Members.map(m => `${m.name.split(' ')[0]} [${m.id}]`);
            topEarnersChart.data.datasets[0].data = top10Members.map(m => m.total_payout);
            topEarnersChart.update();
        }

        // --- Interactivity & Storage ---
        function toggleDetails(rowElement) {
            const detailsRow = rowElement.nextElementSibling;
            if (detailsRow && detailsRow.classList.contains('details-row')) {
                detailsRow.style.display = detailsRow.style.display === 'none' ? 'table-row' : 'none';
            }
        }
        
        function takeScreenshot() {
            const el = document.getElementById('report-container');
            html2canvas(el, { backgroundColor: '#111827', scale: 2 }).then(canvas => {
                const link = document.createElement('a');
                link.download = `war_report_${warId}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }
        
        const storageKey = `warReportSettings-${warId}`;
        function saveToStorage() {
            const settings = {
                isLocked: !document.getElementById('prizeTotalInput').disabled
            };
            inputIds.forEach(id => settings[id] = document.getElementById(id).value);
            localStorage.setItem(storageKey, JSON.stringify(settings));
        }

        function loadFromStorage() {
            const settings = JSON.parse(localStorage.getItem(storageKey));
            if (settings) {
                inputIds.forEach(id => {
                    const inputEl = document.getElementById(id);
                    if (settings[id] !== undefined) {
                        inputEl.value = settings[id];
                    }
                });
                if (settings.isLocked) {
                    toggleLock(true); // Quietly lock without saving
                }
            }
        }

        function toggleLock(quiet = false) {
            const lockButton = document.getElementById('lockButton');
            const icon = lockButton.querySelector('i');
            const areDisabled = inputs[0].disabled;

            inputs.forEach(input => input.disabled = !areDisabled);

            if (areDisabled) { // Were locked, now unlocking
                icon.className = 'fas fa-lock-open';
            } else { // Were unlocked, now locking
                icon.className = 'fas fa-lock';
            }
            if(!quiet) saveToStorage();
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            // Initial Chart Setup
            const poolCtx = document.getElementById('prizePoolChart').getContext('2d');
            prizePoolChart = new Chart(poolCtx, { /* ... Chart options ... */ type: 'doughnut', options: { responsive: true, plugins: { legend: { position: 'top', labels: { color: '#d1d5db' } } } }, data: { labels:[], datasets:[{ backgroundColor: ['#10B981', '#3B82F6', '#F59E0B', '#EF4444'], borderColor: '#1f2937', borderWidth: 4 }]} });
            
            const topEarnersCtx = document.getElementById('topEarnersChart').getContext('2d');
            topEarnersChart = new Chart(topEarnersCtx, { /* ... Chart options ... */ type: 'bar', options: { indexAxis: 'y', responsive: true, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: '#9ca3af', callback: (value) => new Intl.NumberFormat('en-US', { notation: 'compact', compactDisplay: 'short' }).format(value) }, grid: { color: '#374151' } }, y: { ticks: { color: '#d1d5db' }, grid: { display: false } } } }, data: { labels: [], datasets: [{ label: 'Total Payout', backgroundColor: 'rgba(59, 130, 246, 0.7)', borderColor: 'rgba(59, 130, 246, 1)', borderWidth: 1 }]} });

            // Event listeners for dynamic recalculation
            inputs.forEach(input => input.addEventListener('input', calculateAndRender));
            
            loadFromStorage();
            calculateAndRender(); // Initial calculation and render
            toggleLock(true); // Set initial lock state from storage
        });
    </script>
</body>
</html>